# Cloudflare Worker 重构实施计划

## 项目目标
将现有的 Cloudflare Worker 程序转变为纯净的 Headless API 后端，并支持博客网站反向代理。

## 总体目标
1. 移除所有内置的 HTML/UI 逻辑
2. 转变为纯 API 后端
3. 添加全量 CORS 支持
4. 实现根路径 `/` 的博客网站反向代理

---

## 阶段 1: 代码结构分析与识别
**目标**: 完整识别所有需要移除/修改的代码部分
**成功标准**:
- 列出所有 HTML 生成相关的代码位置
- 识别所有现有 API 端点
- 确定 CORS 需要添加的位置

**关键发现**:
- 主要路由:
  - `/api/config` - 配置管理 API
  - `/api/preferred-ips` - 优选IP API
  - `/{UUID}/region` - 地区检测 API
  - `/{UUID}/test-api` - 测试 API
  - `/` - 根路径（当前返回终端 HTML 页面）
  - `/{UUID}` 和 `/{UUID}/sub` - 订阅链接生成

- HTML 生成位置:
  - 行 665-1131: 根路径 `/` 的终端页面（包含多语言支持）
  - 行 2345+: 另一个 HTML 页面
  - 行 4609: HTML 响应头

**测试**: 能够准确列出所有代码修改点
**状态**: 进行中

---

## 阶段 2: 移除 HTML/UI 逻辑
**目标**: 清理所有 HTML/UI 相关代码，保留纯 API 功能
**成功标准**:
- 移除所有 HTML 模板字符串
- 移除终端页面相关代码（translations, terminalHtml 等）
- 移除语言检测逻辑（Cookie/Accept-Language 处理）
- 保留所有现有 API 端点的核心功能

**需要移除的内容**:
1. 根路径 `/` 的终端 HTML 生成（行 665-1131）
2. 多语言翻译对象（行 729-764）
3. Cookie 语言检测逻辑（行 701-724）
4. 其他 HTML 页面生成代码

**需要保留的内容**:
- 所有 API 端点逻辑
- WebSocket 处理
- 代理核心功能
- 配置管理功能

**测试**: 确保所有 API 端点仍然正常工作
**状态**: 未开始

---

## 阶段 3: 实现 CORS 支持
**目标**: 为所有 API 响应添加完整的 CORS 头部
**成功标准**:
- 创建统一的 CORS 头部处理函数
- 处理 OPTIONS 预检请求
- 为所有 API 响应添加 CORS 头部
- 支持配置允许的源（origins）

**实现要点**:
1. 创建 `corsHeaders` 对象:
```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  'Access-Control-Max-Age': '86400',
}
```

2. 创建 `handleOptions` 函数处理 OPTIONS 请求

3. 为所有 API 响应添加 CORS 头部

**测试**: 使用 curl 或浏览器测试跨域请求
**状态**: 未开始

---

## 阶段 4: 实现博客反向代理
**目标**: 让根路径 `/` 完整反向代理博客网站
**成功标准**:
- 根路径返回博客网站内容
- 正确处理静态资源（CSS, JS, 图片等）
- 保持相对路径的正确性
- 转发必要的请求头

**实现要点**:
1. 修改根路径 `/` 的处理逻辑
2. 从环境变量或配置中读取博客 URL
3. 实现完整的反向代理逻辑:
   - 转发请求到目标博客
   - 处理响应头
   - 可选：URL 重写（处理绝对路径）

**配置方式**:
```javascript
const blogUrl = env.BLOG_URL || 'https://your-blog.com'
```

**测试**: 访问根路径，验证博客内容正确显示
**状态**: 未开始

---

## 阶段 5: 代码清理与优化
**目标**: 清理冗余代码，优化结构
**成功标准**:
- 移除未使用的变量和函数
- 优化代码结构
- 添加必要的注释
- 确保代码符合最佳实践

**重点检查**:
- 移除与 HTML 相关的常量和配置
- 清理未使用的翻译逻辑
- 优化错误处理
- 统一响应格式

**测试**: 代码审查，确保没有冗余代码
**状态**: 未开始

---

## 阶段 6: 综合测试
**目标**: 全面测试所有功能
**成功标准**:
- 所有 API 端点正常工作
- CORS 功能正常
- 博客反向代理正常
- WebSocket 连接正常
- 代理核心功能正常

**测试用例**:
1. 测试 `/api/config` 端点（GET/POST）
2. 测试 `/api/preferred-ips` 端点
3. 测试 `/{UUID}/region` 端点
4. 测试 `/{UUID}/test-api` 端点
5. 测试订阅链接生成
6. 测试 CORS 跨域请求
7. 测试根路径博客代理
8. 测试 WebSocket 升级

**测试**: 所有测试用例通过
**状态**: 未开始

---

## 注意事项
1. **保持向后兼容**: 确保现有 API 端点的功能不受影响
2. **安全性**: 确保 CORS 配置不会带来安全风险
3. **性能**: 反向代理不应显著影响性能
4. **错误处理**: 添加适当的错误处理和日志

## 配置变量
重构后需要的新环境变量:
- `BLOG_URL`: 博客网站的 URL（用于反向代理）
- `CORS_ORIGIN`: 允许的 CORS 源（可选，默认为 `*`）
